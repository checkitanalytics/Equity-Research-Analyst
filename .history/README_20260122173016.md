# EquityResearch

## Environment files

- Server runtime (`server/index.ts`) uses `import "dotenv/config"` which loads only `.env` by default.
- Playwright tests (`tests/playwright.config.ts`) load `.env.local` first, then fall back to `.env`.

If you want the server to read `.env.local`, add an explicit `dotenv.config({ path: ".env.local" })` before `dotenv/config` or replace the import with a custom load order.

## Local development

- Install deps: `npm install`.
- Create `.env` (or use your shell env vars). Optional keys used by the server include `OPENAI_API_KEY`, `DEEPSEEK_API_KEY`, `PERPLEXITY_API_KEY`, and `VALUATION_API_URL`. If keys are missing, related routes fall back or return 503.
- Start the dev server: `npm run dev`.
- Open the app at `http://localhost:5173`.

## Testing & Reports

- Local test runs load `.env.local` first, then `.env` (see `tests/playwright.config.ts`).

- Unit tests (Vitest): `npm run test:unit:report`, outputs `test-results/vitest-unit.json` and `test-results/vitest-unit.html`.
- E2E Mock (no network, `MOCK_API=1`): `npm run test:e2e:mock:report`, outputs `test-results/playwright-mock.json` and `test-results/playwright-mock-report`.
- E2E Real (requires network + API keys): `npm run test:e2e:real:report`, outputs `test-results/playwright-real.json` and `test-results/playwright-real-report`. Configure `.env.local`/`.env` with `DEEPSEEK_API_KEY`/`OPENAI_API_KEY`/`PERPLEXITY_API_KEY`/`VALUATION_API_URL`; unreachable services are marked skipped.
- Full flow: `npm run test:flow` runs unit → E2E Mock → E2E Real and writes reports to `test-results/`.
- Playwright artifacts output to `test-results/artifacts` to avoid collisions with HTML report directories.
- Real E2E API responses are stored in `test-results/api-real/*.json`.
- Install test deps: `npm install` (already includes Vitest, Supertest, Playwright, dotenv, etc.). If Playwright browser deps are missing on Manjaro/Arch: `sudo pacman -S --needed icu libxml2 libvpx flite nss libxss at-spi2-core gtk3 libdrm libxkbcommon libxrandr mesa libxrender libxi libxtst alsa-lib cups dbus ttf-liberation pango cairo`. To download browsers: `npx playwright install`.

## Testing Principles

- Unit tests (Vitest + Supertest)
  - Create the Express app with `registerRoutes(app)`, then call each `/api/*` route via Supertest to validate input checks and fallback behavior when external dependencies are missing.
  - External calls are stubbed or conditionally short-circuited (for example, FDA fetch is stubbed; DeepSeek/Perplexity without keys return 503/defaults). Data is truncated in the route layer so no real outbound requests happen.

- E2E tests (Playwright)
  - Mock mode: set `MOCK_API=1`, backend routes return built-in fake data without network access; Playwright validates UI and API through request + browser flows.
  - Real mode: set `REAL_API_TEST=1` with keys; Playwright hits the running dev server (auto-started by config). DeepSeek/Perplexity/OpenAI/valuation/FDA run only if configured/reachable; otherwise tests are marked skipped in reports.
  - Data cutoff: Mock mode returns in-route JSON; Real mode sends real outbound requests (or skips when unreachable) with no extra frontend interception.
